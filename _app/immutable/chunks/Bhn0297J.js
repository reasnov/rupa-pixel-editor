import{_ as W}from"./DfnHKFoC.js";import{C as S,P as B}from"./CgH5Zt4h.js";class G{static toSVG(n,d,a,l="transparent",e=!1){let g=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${n} ${d}" shape-rendering="crispEdges">`;if(l!=="transparent"&&(g+=`<rect width="${n}" height="${d}" fill="${l}" />`),e)a.forEach((f,r)=>{if(f===0)return;const t=S.uint32ToHex(f),i=r%n,s=Math.floor(r/n);g+=`<rect x="${i}" y="${s}" width="1" height="1" fill="${t}" stroke="rgba(0,0,0,0.15)" stroke-width="0.05" />`});else{const f=new Map;for(let r=0;r<a.length;r++){const t=a[r];if(t===0)continue;const i=S.uint32ToHex(t);f.has(i)||f.set(i,new Set),f.get(i).add(r)}f.forEach((r,t)=>{const i=B.traceCluster(r,n);i&&(g+=`<path d="${i}" fill="${t}" />`)})}return g+="</svg>",g}static async toRaster(n,d,a,l,e="png",g="transparent",f=!1){const r=document.createElement("canvas"),t=Math.max(1,Math.round(n*l)),i=Math.max(1,Math.round(d*l));r.width=t,r.height=i;const s=r.getContext("2d");if(!s)throw new Error("Could not get canvas context");s.imageSmoothingEnabled=!1,g!=="transparent"?(s.fillStyle=g,s.fillRect(0,0,t,i)):e==="jpg"&&(s.fillStyle="#ffffff",s.fillRect(0,0,t,i)),a.forEach((w,x)=>{if(w===0)return;const M=S.uint32ToHex(w),m=x%n,p=Math.floor(x/n),h=Math.floor(m*l),y=Math.floor(p*l),u=Math.ceil(l),c=Math.ceil(l);s.fillStyle=M,s.fillRect(h,y,u,c),f&&(s.strokeStyle="rgba(0, 0, 0, 0.15)",s.lineWidth=1,s.strokeRect(h+.5,y+.5,u-1,c-1))});const o=e==="jpg"?"image/jpeg":`image/${e}`;return r.toDataURL(o,.9)}static toAnimatedSVG(n,d,a,l,e="transparent",g=!1){const f=l.reduce((s,o)=>s+o,0),r=(f/1e3).toFixed(3);let t=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${n} ${d}" shape-rendering="crispEdges">`;e!=="transparent"&&(t+=`<rect width="${n}" height="${d}" fill="${e}" />`);let i=0;return a.forEach((s,o)=>{const w=(i/f*100).toFixed(3),x=l[o],M=((i+x)/f*100).toFixed(3),m=`rupa-frame-${o}`;if(t+=`<g class="${m}" style="opacity: 0; visibility: hidden; display: none; animation: ${m} ${r}s step-end infinite;">`,g)s.forEach((p,h)=>{if(p===0)return;const y=S.uint32ToHex(p),u=h%n,c=Math.floor(h/n);t+=`<rect x="${u}" y="${c}" width="1" height="1" fill="${y}" stroke="rgba(0,0,0,0.15)" stroke-width="0.05" />`});else{const p=new Map;for(let h=0;h<s.length;h++){const y=s[h];if(y===0)continue;const u=S.uint32ToHex(y);p.has(u)||p.set(u,new Set),p.get(u).add(h)}p.forEach((h,y)=>{const u=B.traceCluster(h,n);u&&(t+=`<path d="${u}" fill="${y}" />`)})}t+="</g>",t+=`<style>
                @keyframes ${m} {
                    0%, ${w}% { opacity: 0; visibility: hidden; display: none; }
                    ${w}%, ${M}% { opacity: 1; visibility: visible; display: block; }
                    ${M}%, 100% { opacity: 0; visibility: hidden; display: none; }
                }
            </style>`,i+=x}),t+="</svg>",t}static async toVideo(n,d,a,l,e,g="webm",f="transparent",r=!1){const t=document.createElement("canvas"),i=Math.round(n*e),s=Math.round(d*e);t.width=i,t.height=s,t.style.position="fixed",t.style.left="-10000px",t.style.top="-10000px",document.body.appendChild(t);const o=t.getContext("2d",{alpha:!1});o.imageSmoothingEnabled=!1;const w=g==="mp4"&&MediaRecorder.isTypeSupported("video/mp4;codecs=h264")?"video/mp4;codecs=h264":"video/webm;codecs=vp8",x=t.captureStream(0),M=x.getVideoTracks()[0],m=new MediaRecorder(x,{mimeType:w,videoBitsPerSecond:8e6}),p=[];return m.ondataavailable=h=>{h.data.size>0&&p.push(h.data)},new Promise((h,y)=>{m.onstop=()=>{document.body.removeChild(t);const c=new Blob(p,{type:w});h(c)},m.onerror=c=>{document.body.removeChild(t),y(c)},m.start();const u=c=>{o.fillStyle=f==="transparent"?"#ffffff":f,o.fillRect(0,0,i,s);const b=a[c];for(let $=0;$<b.length;$++){const v=b[$];if(v===0)continue;const R=S.uint32ToHex(v),F=$%n,H=Math.floor($/n),P=Math.floor(F*e),E=Math.floor(H*e),k=Math.ceil(e),T=Math.ceil(e);o.fillStyle=R,o.fillRect(P,E,k,T),r&&(o.strokeStyle="rgba(0, 0, 0, 0.15)",o.lineWidth=1,o.strokeRect(P+.5,E+.5,k-1,T-1))}o.getImageData(0,0,1,1)};(async()=>{await new Promise(c=>setTimeout(c,200));for(let c=0;c<a.length;c++)u(c),M&&M.requestFrame&&M.requestFrame(),await new Promise(b=>setTimeout(b,l[c]));await new Promise(c=>setTimeout(c,500)),m.stop(),x.getTracks().forEach(c=>c.stop())})()})}static async toGIF(n,d,a,l,e,g="transparent",f=!1){const{GifWriter:r}=await W(async()=>{const{GifWriter:p}=await import("./CHXe66Ai.js");return{GifWriter:p}},[],import.meta.url),t=Math.round(n*e),i=Math.round(d*e),s=document.createElement("canvas");s.width=t,s.height=i;const o=s.getContext("2d",{alpha:!0});o.imageSmoothingEnabled=!1;const w=new Uint8Array(a.length*t*i*2),x=new r(w,t,i,{loop:0});let M=0;for(let p=0;p<a.length;p++){o.clearRect(0,0,t,i),g!=="transparent"&&(o.fillStyle=g,o.fillRect(0,0,t,i));const h=a[p];for(let v=0;v<h.length;v++){const R=h[v];if(R===0)continue;const F=S.uint32ToHex(R),H=v%n,P=Math.floor(v/n),E=Math.floor(H*e),k=Math.floor(P*e),T=Math.ceil(e),C=Math.ceil(e);o.fillStyle=F,o.fillRect(E,k,T,C),f&&(o.strokeStyle="rgba(0, 0, 0, 0.15)",o.lineWidth=1,o.strokeRect(E+.5,k+.5,T-1,C-1))}const y=o.getImageData(0,0,t,i).data,{indexedPixels:u,palette:c}=this.quantizeFrame(y),b=l[p]+M,$=Math.max(1,Math.round(b/10));M=b-$*10,x.addFrame(0,0,t,i,u,{palette:c,delay:$}),await new Promise(v=>setTimeout(v,0))}const m=w.slice(0,x.end());return new Blob([m],{type:"image/gif"})}static quantizeFrame(n){const d=new Map,a=[],l=new Array(n.length/4);for(let e=0;e<n.length;e+=4){const g=n[e],f=n[e+1],r=n[e+2];if(n[e+3]<128){const o="0,0,0,0";d.has(o)||(d.set(o,a.length),a.push(0)),l[e/4]=d.get(o);continue}const i=g<<16|f<<8|r,s=`${g},${f},${r}`;if(!d.has(s)){if(a.length>=256){l[e/4]=0;continue}d.set(s,a.length),a.push(i)}l[e/4]=d.get(s)}for(;a.length<2||(a.length&a.length-1)!==0;)a.push(0);return{indexedPixels:l,palette:a}}}export{G as ExportEngine};
