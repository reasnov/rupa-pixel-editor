import{_ as C}from"./B78w-WDr.js";import{C as T,P as W}from"./BzLopwom.js";class L{static async toSVG(i,d,a,l="transparent",n=!1,u){let p=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${i} ${d}" shape-rendering="crispEdges">`;if(l!=="transparent"&&(p+=`<rect width="${i}" height="${d}" fill="${l}" />`),n)a.forEach((c,g)=>{if(c===0)return;const t=T.uint32ToHex(c),e=g%i,s=Math.floor(g/i);p+=`<rect x="${e}" y="${s}" width="1" height="1" fill="${t}" stroke="rgba(0,0,0,0.15)" stroke-width="0.05" />`}),u&&u(1);else{const c=new Map;for(let t=0;t<a.length;t++){const e=a[t];if(e===0)continue;const s=T.uint32ToHex(e);c.has(s)||c.set(s,new Set),c.get(s).add(t)}const g=Array.from(c.keys());for(let t=0;t<g.length;t++){const e=g[t],s=c.get(e),o=W.traceCluster(s,i);o&&(p+=`<path d="${o}" fill="${e}" />`),u&&u((t+1)/g.length),await new Promise(y=>setTimeout(y,0))}}return p+="</svg>",p}static async toRaster(i,d,a,l,n="png",u="transparent",p=!1){const c=document.createElement("canvas"),g=Math.max(1,Math.round(i*l)),t=Math.max(1,Math.round(d*l));c.width=g,c.height=t;const e=c.getContext("2d");if(!e)throw new Error("Could not get canvas context");e.imageSmoothingEnabled=!1,u!=="transparent"?(e.fillStyle=u,e.fillRect(0,0,g,t)):n==="jpg"&&(e.fillStyle="#ffffff",e.fillRect(0,0,g,t)),a.forEach((o,y)=>{if(o===0)return;const v=T.uint32ToHex(o),$=y%i,w=Math.floor(y/i),r=Math.floor($*l),h=Math.floor(w*l),x=Math.ceil(l),m=Math.ceil(l);e.fillStyle=v,e.fillRect(r,h,x,m),p&&(e.strokeStyle="rgba(0, 0, 0, 0.15)",e.lineWidth=1,e.strokeRect(r+.5,h+.5,x-1,m-1))});const s=n==="jpg"?"image/jpeg":`image/${n}`;return c.toDataURL(s,.9)}static async toAnimatedSVG(i,d,a,l,n="transparent",u=!1,p){const c=l.reduce((s,o)=>s+o,0),g=(c/1e3).toFixed(3);let t=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${i} ${d}" shape-rendering="crispEdges">`;n!=="transparent"&&(t+=`<rect width="${i}" height="${d}" fill="${n}" />`);let e=0;for(let s=0;s<a.length;s++){const o=a[s],y=(e/c*100).toFixed(3),v=l[s],$=((e+v)/c*100).toFixed(3),w=`rupa-frame-${s}`;if(t+=`<g class="${w}" style="opacity: 0; visibility: hidden; display: none; animation: ${w} ${g}s step-end infinite;">`,u)o.forEach((r,h)=>{if(r===0)return;const x=T.uint32ToHex(r),m=h%i,f=Math.floor(h/i);t+=`<rect x="${m}" y="${f}" width="1" height="1" fill="${x}" stroke="rgba(0,0,0,0.15)" stroke-width="0.05" />`});else{const r=new Map;for(let h=0;h<o.length;h++){const x=o[h];if(x===0)continue;const m=T.uint32ToHex(x);r.has(m)||r.set(m,new Set),r.get(m).add(h)}r.forEach((h,x)=>{const m=W.traceCluster(h,i);m&&(t+=`<path d="${m}" fill="${x}" />`)})}t+="</g>",t+=`<style>
                @keyframes ${w} {
                    0%, ${y}% { opacity: 0; visibility: hidden; display: none; }
                    ${y}%, ${$}% { opacity: 1; visibility: visible; display: block; }
                    ${$}%, 100% { opacity: 0; visibility: hidden; display: none; }
                }
            </style>`,e+=v,p&&p((s+1)/a.length),await new Promise(r=>setTimeout(r,0))}return t+="</svg>",t}static async toVideo(i,d,a,l,n,u="webm",p="transparent",c=!1,g){const t=document.createElement("canvas"),e=Math.round(i*n),s=Math.round(d*n);t.width=e,t.height=s,t.style.position="fixed",t.style.left="-10000px",t.style.top="-10000px",document.body.appendChild(t);const o=t.getContext("2d",{alpha:!1});o.imageSmoothingEnabled=!1;const y=u==="mp4"&&MediaRecorder.isTypeSupported("video/mp4;codecs=h264")?"video/mp4;codecs=h264":"video/webm;codecs=vp8",v=t.captureStream(0),$=v.getVideoTracks()[0],w=new MediaRecorder(v,{mimeType:y,videoBitsPerSecond:8e6}),r=[];return w.ondataavailable=h=>{h.data.size>0&&r.push(h.data)},new Promise((h,x)=>{w.onstop=async()=>{document.body.removeChild(t);const f=new Blob(r,{type:y});try{const{EbmlLogic:b}=await C(async()=>{const{EbmlLogic:S}=await import("./CZgxh6Lg.js");return{EbmlLogic:S}},[],import.meta.url),E=l.reduce((S,k)=>S+k,0),M=await b.injectMetadata(f,E);h(M)}catch(b){console.warn("Metadata injection failed, returning raw video:",b),h(f)}},w.onerror=f=>{document.body.removeChild(t),x(f)},w.start();const m=f=>{o.fillStyle=p==="transparent"?"#ffffff":p,o.fillRect(0,0,e,s);const b=a[f];for(let E=0;E<b.length;E++){const M=b[E];if(M===0)continue;const S=T.uint32ToHex(M),k=E%i,F=Math.floor(E/i),B=Math.floor(k*n),R=Math.floor(F*n),_=Math.ceil(n),P=Math.ceil(n);o.fillStyle=S,o.fillRect(B,R,_,P),c&&(o.strokeStyle="rgba(0, 0, 0, 0.15)",o.lineWidth=1,o.strokeRect(B+.5,R+.5,_-1,P-1))}o.getImageData(0,0,1,1)};(async()=>{await new Promise(f=>setTimeout(f,200));for(let f=0;f<a.length;f++)m(f),$&&$.requestFrame&&$.requestFrame(),await new Promise(b=>setTimeout(b,l[f])),g&&g((f+1)/a.length);await new Promise(f=>setTimeout(f,500)),w.stop(),v.getTracks().forEach(f=>f.stop())})()})}static async toGIF(i,d,a,l,n,u="transparent",p=!1,c){const{GifWriter:g}=await C(async()=>{const{GifWriter:r}=await import("./CHXe66Ai.js");return{GifWriter:r}},[],import.meta.url),t=Math.round(i*n),e=Math.round(d*n),s=document.createElement("canvas");s.width=t,s.height=e;const o=s.getContext("2d",{alpha:!0});o.imageSmoothingEnabled=!1;const y=new Uint8Array(a.length*t*e*2),v=new g(y,t,e,{loop:0});let $=0;for(let r=0;r<a.length;r++){o.clearRect(0,0,t,e),u!=="transparent"&&(o.fillStyle=u,o.fillRect(0,0,t,e));const h=a[r];for(let M=0;M<h.length;M++){const S=h[M];if(S===0)continue;const k=T.uint32ToHex(S),F=M%i,B=Math.floor(M/i),R=Math.floor(F*n),_=Math.floor(B*n),P=Math.ceil(n),H=Math.ceil(n);o.fillStyle=k,o.fillRect(R,_,P,H),p&&(o.strokeStyle="rgba(0, 0, 0, 0.15)",o.lineWidth=1,o.strokeRect(R+.5,_+.5,P-1,H-1))}const x=o.getImageData(0,0,t,e).data,{indexedPixels:m,palette:f}=this.quantizeFrame(x),b=l[r]+$,E=Math.max(1,Math.round(b/10));$=b-E*10,v.addFrame(0,0,t,e,m,{palette:f,delay:E}),c&&c((r+1)/a.length),await new Promise(M=>setTimeout(M,0))}const w=y.slice(0,v.end());return new Blob([w],{type:"image/gif"})}static quantizeFrame(i){const d=new Map,a=[],l=new Array(i.length/4);for(let n=0;n<i.length;n+=4){const u=i[n],p=i[n+1],c=i[n+2];if(i[n+3]<128){const s="0,0,0,0";d.has(s)||(d.set(s,a.length),a.push(0)),l[n/4]=d.get(s);continue}const t=u<<16|p<<8|c,e=`${u},${p},${c}`;if(!d.has(e)){if(a.length>=256){l[n/4]=0;continue}d.set(e,a.length),a.push(t)}l[n/4]=d.get(e)}for(;a.length<2||(a.length&a.length-1)!==0;)a.push(0);return{indexedPixels:l,palette:a}}}export{L as ExportEngine};
