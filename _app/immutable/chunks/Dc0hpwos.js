import{_ as L}from"./BuzRps0s.js";import{C as _}from"./Cs19ozkJ.js";function j(A){return new Worker(""+new URL("../workers/export.worker-WPTgFNub.js",import.meta.url).href,{name:A?.name})}class I{static async runWorkerTask(n,p,i){return new Promise((a,e)=>{const l=new j;l.onmessage=f=>{const{type:r,payload:d}=f.data;r==="PROGRESS"&&i?i(d):r==="DONE"&&(l.terminate(),a(d))},l.onerror=f=>{l.terminate(),e(f)},l.postMessage({type:n,payload:p})})}static async toSVG(n,p,i,a="transparent",e=!1,l){let f=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${n} ${p}" shape-rendering="crispEdges">`;return a!=="transparent"&&(f+=`<rect width="${n}" height="${p}" fill="${a}" />`),e?(i.forEach((r,d)=>{if(r===0)return;const t=_.uint32ToHex(r),o=d%n,c=Math.floor(d/n);f+=`<rect x="${o}" y="${c}" width="1" height="1" fill="${t}" stroke="rgba(0,0,0,0.15)" stroke-width="0.05" />`}),l&&l(1)):(await this.runWorkerTask("TRACE_CLUSTERS",{width:n,data:i},l)).forEach(({color:d,pathData:t})=>{t&&(f+=`<path d="${t}" fill="${d}" />`)}),f+="</svg>",f}static async toRaster(n,p,i,a,e="png",l="transparent",f=!1){const r=document.createElement("canvas"),d=Math.max(1,Math.round(n*a)),t=Math.max(1,Math.round(p*a));r.width=d,r.height=t;const o=r.getContext("2d");if(!o)throw new Error("Could not get canvas context");o.imageSmoothingEnabled=!1,l!=="transparent"?(o.fillStyle=l,o.fillRect(0,0,d,t)):e==="jpg"&&(o.fillStyle="#ffffff",o.fillRect(0,0,d,t)),i.forEach((s,w)=>{if(s===0)return;const x=_.uint32ToHex(s),M=w%n,m=Math.floor(w/n),u=Math.floor(M*a),g=Math.floor(m*a),$=Math.ceil(a),E=Math.ceil(a);o.fillStyle=x,o.fillRect(u,g,$,E),f&&(o.strokeStyle="rgba(0, 0, 0, 0.15)",o.lineWidth=1,o.strokeRect(u+.5,g+.5,$-1,E-1))});const c=e==="jpg"?"image/jpeg":`image/${e}`;return r.toDataURL(c,.9)}static async toAnimatedSVG(n,p,i,a,e="transparent",l=!1,f){const r=a.reduce((c,s)=>c+s,0),d=(r/1e3).toFixed(3);let t=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${n} ${p}" shape-rendering="crispEdges">`;e!=="transparent"&&(t+=`<rect width="${n}" height="${p}" fill="${e}" />`);let o=0;for(let c=0;c<i.length;c++){const s=i[c],w=(o/r*100).toFixed(3),x=a[c],M=((o+x)/r*100).toFixed(3),m=`rupa-frame-${c}`;t+=`<g class="${m}" style="opacity: 0; visibility: hidden; display: none; animation: ${m} ${d}s step-end infinite;">`,l?s.forEach((u,g)=>{if(u===0)return;const $=_.uint32ToHex(u),E=g%n,h=Math.floor(g/n);t+=`<rect x="${E}" y="${h}" width="1" height="1" fill="${$}" stroke="rgba(0,0,0,0.15)" stroke-width="0.05" />`}):(await this.runWorkerTask("TRACE_CLUSTERS",{width:n,data:s})).forEach(({color:g,pathData:$})=>{$&&(t+=`<path d="${$}" fill="${g}" />`)}),t+="</g>",t+=`<style>
                @keyframes ${m} {
                    0%, ${w}% { opacity: 0; visibility: hidden; display: none; }
                    ${w}%, ${M}% { opacity: 1; visibility: visible; display: block; }
                    ${M}%, 100% { opacity: 0; visibility: hidden; display: none; }
                }
            </style>`,o+=x,f&&f((c+1)/i.length)}return t+="</svg>",t}static async toVideo(n,p,i,a,e,l="webm",f="transparent",r=!1,d){const t=document.createElement("canvas"),o=Math.round(n*e),c=Math.round(p*e);t.width=o,t.height=c,t.style.position="fixed",t.style.left="-10000px",t.style.top="-10000px",document.body.appendChild(t);const s=t.getContext("2d",{alpha:!1});s.imageSmoothingEnabled=!1;const w=l==="mp4"&&MediaRecorder.isTypeSupported("video/mp4;codecs=h264")?"video/mp4;codecs=h264":"video/webm;codecs=vp8",x=t.captureStream(0),M=x.getVideoTracks()[0],m=new MediaRecorder(x,{mimeType:w,videoBitsPerSecond:8e6}),u=[];return m.ondataavailable=g=>{g.data.size>0&&u.push(g.data)},new Promise((g,$)=>{m.onstop=async()=>{document.body.removeChild(t);const h=new Blob(u,{type:w});try{const{EbmlLogic:k}=await L(async()=>{const{EbmlLogic:T}=await import("./CZgxh6Lg.js");return{EbmlLogic:T}},[],import.meta.url),v=a.reduce((T,S)=>T+S,0),y=await k.injectMetadata(h,v);g(y)}catch(k){console.warn("Metadata injection failed:",k),g(h)}},m.onerror=h=>{document.body.removeChild(t),$(h)},m.start();const E=h=>{s.fillStyle=f==="transparent"?"#ffffff":f,s.fillRect(0,0,o,c);const k=i[h];for(let v=0;v<k.length;v++){const y=k[v];if(y===0)continue;const T=_.uint32ToHex(y),S=v%n,P=Math.floor(v/n),F=Math.floor(S*e),b=Math.floor(P*e),R=Math.ceil(e),W=Math.ceil(e);s.fillStyle=T,s.fillRect(F,b,R,W),r&&(s.strokeStyle="rgba(0, 0, 0, 0.15)",s.lineWidth=1,s.strokeRect(F+.5,b+.5,R-1,W-1))}s.getImageData(0,0,1,1)};(async()=>{await new Promise(h=>setTimeout(h,200));for(let h=0;h<i.length;h++)E(h),M&&M.requestFrame&&M.requestFrame(),await new Promise(k=>setTimeout(k,a[h])),d&&d((h+1)/i.length);await new Promise(h=>setTimeout(h,500)),m.stop(),x.getTracks().forEach(h=>h.stop())})()})}static async toGIF(n,p,i,a,e,l="transparent",f=!1,r){const{GifWriter:d}=await L(async()=>{const{GifWriter:u}=await import("./DVkwEjOK.js");return{GifWriter:u}},[],import.meta.url),t=Math.round(n*e),o=Math.round(p*e),c=document.createElement("canvas");c.width=t,c.height=o;const s=c.getContext("2d",{alpha:!0});s.imageSmoothingEnabled=!1;const w=new Uint8Array(i.length*t*o*2),x=new d(w,t,o,{loop:0});let M=0;for(let u=0;u<i.length;u++){s.clearRect(0,0,t,o),l!=="transparent"&&(s.fillStyle=l,s.fillRect(0,0,t,o));const g=i[u];for(let y=0;y<g.length;y++){const T=g[y];if(T===0)continue;const S=_.uint32ToHex(T),P=y%n,F=Math.floor(y/n),b=Math.floor(P*e),R=Math.floor(F*e),W=Math.ceil(e),C=Math.ceil(e);s.fillStyle=S,s.fillRect(b,R,W,C),f&&(s.strokeStyle="rgba(0, 0, 0, 0.15)",s.lineWidth=1,s.strokeRect(b+.5,R+.5,W-1,C-1))}const $=s.getImageData(0,0,t,o).data,{indexedPixels:E,palette:h}=await this.runWorkerTask("QUANTIZE_FRAME",{imageData:$}),k=a[u]+M,v=Math.max(1,Math.round(k/10));M=k-v*10,x.addFrame(0,0,t,o,E,{palette:h,delay:v}),r&&r((u+1)/i.length),await new Promise(y=>setTimeout(y,0))}const m=w.slice(0,x.end());return new Blob([m],{type:"image/gif"})}static quantizeFrame(n){const p=new Map,i=[],a=new Array(n.length/4);for(let e=0;e<n.length;e+=4){const l=n[e],f=n[e+1],r=n[e+2];if(n[e+3]<128){const c="0,0,0,0";p.has(c)||(p.set(c,i.length),i.push(0)),a[e/4]=p.get(c);continue}const t=l<<16|f<<8|r,o=`${l},${f},${r}`;if(!p.has(o)){if(i.length>=256){a[e/4]=0;continue}p.set(o,i.length),i.push(t)}a[e/4]=p.get(o)}for(;i.length<2||(i.length&i.length-1)!==0;)i.push(0);return{indexedPixels:a,palette:i}}}export{I as ExportEngine};
