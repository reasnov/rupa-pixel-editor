(function(){"use strict";self.onmessage=async i=>{const{type:c,payload:s}=i.data;if(c==="TRACE_CLUSTERS"){const{width:f,data:o}=s,t=new Map;for(let e=0;e<o.length;e++){const a=o[e];if(a===0)continue;const r=a&255,l=a>>8&255,h=a>>16&255,g=`#${r.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}${h.toString(16).padStart(2,"0")}`;t.has(g)||t.set(g,new Set),t.get(g).add(e)}const n=[],p=Array.from(t.keys());for(let e=0;e<p.length;e++){const a=p[e],r=t.get(a),l=u(r,f);n.push({color:a,pathData:l}),self.postMessage({type:"PROGRESS",payload:(e+1)/p.length})}self.postMessage({type:"DONE",payload:n})}else if(c==="QUANTIZE_FRAME"){const{imageData:f}=s,o=d(f);self.postMessage({type:"DONE",payload:o})}};function d(i){const c=new Map,s=[],f=new Array(i.length/4);for(let o=0;o<i.length;o+=4){const t=i[o],n=i[o+1],p=i[o+2];if(i[o+3]<128){const l="0,0,0,0";c.has(l)||(c.set(l,s.length),s.push(0)),f[o/4]=c.get(l);continue}const a=t<<16|n<<8|p,r=`${t},${n},${p}`;if(!c.has(r)){if(s.length>=256){f[o/4]=0;continue}c.set(r,s.length),s.push(a)}f[o/4]=c.get(r)}for(;s.length<2||(s.length&s.length-1)!==0;)s.push(0);return{indexedPixels:f,palette:s}}function u(i,c){const s=new Set;for(const o of i){const t=o%c,n=Math.floor(o/c);[{x:t,y:n-1,id:"top"},{x:t+1,y:n,id:"right"},{x:t,y:n+1,id:"bottom"},{x:t-1,y:n,id:"left"}].forEach(e=>{const a=e.y*c+e.x;if(e.x<0||e.x>=c||e.y<0||!i.has(a)){let l;e.id==="top"?l=`${t},${n}-${t+1},${n}`:e.id==="right"?l=`${t+1},${n}-${t+1},${n+1}`:e.id==="bottom"?l=`${t+1},${n+1}-${t},${n+1}`:l=`${t},${n+1}-${t},${n}`,s.add(l)}})}const f=[];for(;s.size>0;){const o=s.values().next();if(o.done)break;const t=o.value;s.delete(t);const[n,p]=t.split("-");let e=p,a=`M ${n.replace(","," ")} L ${p.replace(","," ")}`,r=!0;for(;r;){r=!1;for(const l of s)if(l.startsWith(e+"-")){const[h,g]=l.split("-");a+=` L ${g.replace(","," ")}`,e=g,s.delete(l),r=!0;break}}a+=" Z",f.push(a)}return f.join(" ")}})();
